# =============================================================================
# Atomic Release Workflow (Reusable)
# =============================================================================
#
# This reusable workflow handles the packaging and publishing process.
# It runs on multiple platforms (macOS, Windows, Linux) to:
#   - Download build artifacts
#   - Package the application
#   - Publish to GitHub Releases
#
# =============================================================================

name: Release (Reusable)

on:
  workflow_call:

env:
  NODE_VERSION: '20'
  CI: true
  ELECTRON_ENABLE_LOGGING: true

jobs:
  release:
    name: Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # Download build artifacts from _build.yml
      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Download Electron Build
        uses: actions/download-artifact@v4
        with:
          name: electron-dist
          path: dist-electron/

      # Delete existing assets for this platform before uploading (handles re-runs)
      - name: Delete Existing Release Assets
        run: |
          # Get release info
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }} --jq '.id' 2>/dev/null || echo "")
          if [ -z "$RELEASE_ID" ]; then
            echo "No existing release found, skipping asset deletion"
            exit 0
          fi
          
          # Define platform-specific patterns
          case "${{ runner.os }}" in
            "macOS")
              PATTERNS="\.dmg$|\.zip$|\.zip\.blockmap$|latest-mac\.yml$"
              ;;
            "Windows")
              PATTERNS="\.exe$|\.exe\.blockmap$|latest\.yml$"
              ;;
            "Linux")
              PATTERNS="\.AppImage$|\.deb$|\.rpm$|\.tar\.gz$|latest-linux\.yml$"
              ;;
          esac
          
          echo "Listing assets for Release ID: $RELEASE_ID"
          
          # List all assets with names and IDs, handling pagination
          # Output format: ID <tab> Name
          gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --paginate --jq '.[] | "\(.id)\t\(.name)"' | while read -r line; do
            ASSET_ID=$(echo "$line" | cut -f1)
            ASSET_NAME=$(echo "$line" | cut -f2)
            
            if echo "$ASSET_NAME" | grep -qE "$PATTERNS"; then
              echo "Deleting existing asset: $ASSET_NAME ($ASSET_ID)"
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        continue-on-error: true

      # Run Electron Builder
      # This step builds the artifacts and uploads them to the GitHub Release
      - name: Build & Publish via Electron Builder
        run: npx --yes electron-builder --publish always
        env:
          # GitHub token for publishing releases
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # macOS Signing & Notarization Secrets (Optional - Empty = Unsigned)
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          
          # Windows Signing Secrets (Optional - Empty = Unsigned)
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      # Upload build artifacts for debugging if needed
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts-${{ matrix.os }}
          path: release/
          retention-days: 7
          if-no-files-found: ignore
