# =============================================================================
# GitHub Actions Release Workflow
# =============================================================================
#
# This workflow handles the automated release process for Gemini Desktop.
# It triggers on version tags (v*), executing:
#   - Build (via _build.yml)
#   - Quality Gate Tests (via _test.yml, fail-fast enabled)
#   - Release Packaging & Publishing (via _release.yml)
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # Allow manual triggering for testing

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write # Required for creating releases

# =============================================================================
# Environment Variables
# =============================================================================
env:
  NODE_VERSION: '20'
  CI: true
  ELECTRON_ENABLE_LOGGING: true

jobs:
  # Build application
  build:
    uses: ./.github/workflows/_build.yml
  
  # Run tests (no coverage uploads, fail-fast enabled for release quality gate)
  test:
    needs: build
    uses: ./.github/workflows/_test.yml
    with:
      upload-coverage: false
      e2e-fail-fast: true
      artifact-suffix: '-release'
  
  # Build and publish release after tests pass
  release:
    needs: [build, test]
    uses: ./.github/workflows/_release.yml
    secrets: inherit
